using System;using System.Collections.Generic;using System.Numerics;using System.Runtime.InteropServices;using Silk.NET.Input;using Silk.NET.OpenGL;using Silk.NET.OpenGL.Extensions.ImGui;using Silk.NET.Windowing;using Silk.NET.Maths;using ImGuiNET;
unsafe class G:IDisposable{IWindow w;GL g;IInputContext i;IMouse m;IKeyboard k;uint v,b,e,s;float[]d;uint[]l;Vector3 p=new(0,2,5),vel;Matrix4x4 vw,pr;List<E>en=new();List<P>pj=new();List<O>ob=new();float h=100,mh=100,ft=1f/60f,mx,my,js=7,ms=8,sens=.001f,fov=75;int wv=1,ki,am=50,mm=50,wt;bool gr,de,fl;double ac,ht;Random r=new();ImGuiController ic;
const string vs=@"#version 330 core
layout(location=0)in vec3 aPos;layout(location=1)in vec3 aCol;out vec3 Col;uniform mat4 model;uniform mat4 view;uniform mat4 proj;void main(){gl_Position=proj*view*model*vec4(aPos,1.0);Col=aCol;}",fs=@"#version 330 core
in vec3 Col;out vec4 FragColor;uniform float flash;void main(){FragColor=vec4(Col*(1.0+flash*2.0),1.0);}";
static void Main(){var o=WindowOptions.Default with{Size=new(1280,720),Title="FPS Arena",VSync=false};var w=Window.Create(o);w.Load+=()=>{var g=new G();g.I(w,GL.GetApi(w));w.Update+=g.U;w.Render+=g.R;w.Closing+=g.Dispose;};w.Run();}
void I(IWindow win,GL gl){w=win;g=gl;g.Enable(EnableCap.DepthTest);g.Enable(EnableCap.CullFace);g.ClearColor(.05f,.05f,.1f,1);i=w.CreateInput();m=i.Mice[0];k=i.Keyboards[0];m.Cursor.CursorMode=CursorMode.Raw;m.MouseMove+=(m,pos)=>{mx+=pos.X*sens;my=Math.Clamp(my-pos.Y*sens,-1.3f,1.3f);};k.KeyDown+=(k,key,_)=>{if(key==Key.Space&&gr)vel.Y=js;if(key==Key.R&&de){de=false;h=mh;p=new(0,2,5);en.Clear();wv=1;ki=0;SW();}if(key==Key.Number1)wt=0;if(key==Key.Number2)wt=1;if(key==Key.Number3)wt=2;if(key==Key.Escape)w.Close();};ic=new(g,w,i);d=new[]{-.5f,-.5f,-.5f,1,1,1,.5f,-.5f,-.5f,1,1,1,.5f,.5f,-.5f,1,1,1,-.5f,.5f,-.5f,1,1,1,-.5f,-.5f,.5f,1,1,1,.5f,-.5f,.5f,1,1,1,.5f,.5f,.5f,1,1,1,-.5f,.5f,.5f,1,1,1};l=new uint[]{0,1,2,2,3,0,4,5,6,6,7,4,0,4,7,7,3,0,1,5,6,6,2,1,3,2,6,6,7,3,0,1,5,5,4,0};v=g.GenVertexArray();b=g.GenBuffer();e=g.GenBuffer();g.BindVertexArray(v);g.BindBuffer(BufferTargetARB.ArrayBuffer,b);fixed(void*ptr=d)g.BufferData(BufferTargetARB.ArrayBuffer,(nuint)(d.Length*sizeof(float)),ptr,BufferUsageARB.StaticDraw);g.BindBuffer(BufferTargetARB.ElementArrayBuffer,e);fixed(void*ptr=l)g.BufferData(BufferTargetARB.ElementArrayBuffer,(nuint)(l.Length*sizeof(uint)),ptr,BufferUsageARB.StaticDraw);g.VertexAttribPointer(0,3,VertexAttribPointerType.Float,false,6*sizeof(float),(void*)0);g.EnableVertexAttribArray(0);g.VertexAttribPointer(1,3,VertexAttribPointerType.Float,false,6*sizeof(float),(void*)(3*sizeof(float)));g.EnableVertexAttribArray(1);var vsh=g.CreateShader(ShaderType.VertexShader);g.ShaderSource(vsh,vs);g.CompileShader(vsh);var fsh=g.CreateShader(ShaderType.FragmentShader);g.ShaderSource(fsh,fs);g.CompileShader(fsh);s=g.CreateProgram();g.AttachShader(s,vsh);g.AttachShader(s,fsh);g.LinkProgram(s);g.DeleteShader(vsh);g.DeleteShader(fsh);for(int x=-30;x<=30;x+=8)for(int z=-30;z<=30;z+=8)if(r.NextDouble()>.6)ob.Add(new O{p=new(x,.5f,z),s=new(2,1,2),c=new(.3f,.3f,.4f)});ob.Add(new O{p=new(0,-1,0),s=new(100,.1f,100),c=new(.2f,.2f,.25f)});SW();}
void U(double dt){if(de&&ht>0){ht-=dt;if(ht<=0)de=false;}ac+=dt;while(ac>=ft){if(!de){vel.Y-=20f*ft;var mv=Vector3.Zero;if(k.IsKeyPressed(Key.W))mv.Z=-1;if(k.IsKeyPressed(Key.S))mv.Z=1;if(k.IsKeyPressed(Key.A))mv.X=-1;if(k.IsKeyPressed(Key.D))mv.X=1;if(k.IsKeyPressed(Key.ShiftLeft))ms=12;else ms=8;if(mv.LengthSquared()>0){mv=Vector3.Normalize(mv);var fw=new Vector3((float)Math.Sin(mx),0,(float)-Math.Cos(mx));var rt=Vector3.Normalize(Vector3.Cross(fw,Vector3.UnitY));mv=rt*mv.X+Vector3.Cross(Vector3.UnitY,rt)*mv.Z;p+=mv*ms*ft;}p.Y+=vel.Y*ft;if(p.Y<=2){p.Y=2;vel.Y=0;gr=true;}else gr=false;foreach(var o in ob)if(Math.Abs(p.X-o.p.X)<o.s.X&&Math.Abs(p.Z-o.p.Z)<o.s.Z&&p.Y<o.p.Y+o.s.Y&&p.Y>o.p.Y-1){p.Y=o.p.Y+o.s.Y;vel.Y=0;gr=true;}if(m.IsButtonPressed(MouseButton.Left)&&am>0){am--;var dir=new Vector3((float)Math.Sin(mx),(float)Math.Sin(my),(float)-Math.Cos(mx));pj.Add(new P{p=p+new Vector3(0,0,0)+dir*.5f,v=dir*30,l=3,c=new(1,1,0)});fl=true;}if(m.IsButtonPressed(MouseButton.Right)&&am>=5){am-=5;for(float a=-0.2f;a<=0.2f;a+=0.1f){var dir=new Vector3((float)Math.Sin(mx+a),(float)Math.Sin(my),(float)-Math.Cos(mx+a));pj.Add(new P{p=p+dir*.5f,v=dir*25,l=2,c=new(1,.5f,0)});}}for(int i=en.Count-1;i>=0;i--){en[i].U(ft,p);if(Vector3.Distance(en[i].p,p)<1.8f){h-=5;fl=true;if(h<=0){de=true;h=0;ht=3;}}}for(int i=pj.Count-1;i>=0;i--){pj[i].U(ft);if(pj[i].l<=0||pj[i].p.Y<0)pj.RemoveAt(i);}for(int i=pj.Count-1;i>=0;i--)for(int j=en.Count-1;j>=0;j--)if(Vector3.Distance(pj[i].p,en[j].p)<1.5f){en[j].h-=wt==0?50:wt==1?20:100;en[j].ht=.1f;if(en[j].h<=0){en.RemoveAt(j);ki++;if(ki%10==0){h=Math.Min(h+20,mh);am+=10;}}pj.RemoveAt(i);break;}}if(en.Count==0)SW();ac-=ft;if(fl){fl=false;ht=.05f;}}ic.Update((float)dt);var fw2=new Vector3((float)Math.Sin(mx),(float)Math.Sin(my),(float)-Math.Cos(mx));vw=Matrix4x4.CreateLookAt(p+new Vector3(0,0,0),p+fw2,Vector3.UnitY);pr=Matrix4x4.CreatePerspectiveFieldOfView(fov*MathF.PI/180,w.Size.X/(float)w.Size.Y,0.1f,100f);}
void R(double dt){g.Clear(ClearBufferMask.ColorBufferBit|ClearBufferMask.DepthBufferBit);g.UseProgram(s);var ml=g.GetUniformLocation(s,"model");var vl=g.GetUniformLocation(s,"view");var pl=g.GetUniformLocation(s,"proj");var fl=g.GetUniformLocation(s,"flash");g.Uniform1(fl,ht>0?1f:0f);var vwt=vw;var prt=pr;g.UniformMatrix4(vl,1,false,(float*)&vwt);g.UniformMatrix4(pl,1,false,(float*)&prt);g.BindVertexArray(v);foreach(var o in ob){var t=Matrix4x4.CreateScale(o.s)*Matrix4x4.CreateTranslation(o.p);g.UniformMatrix4(ml,1,false,(float*)&t);g.VertexAttribPointer(1,3,VertexAttribPointerType.Float,false,6*sizeof(float),(void*)(3*sizeof(float)));g.VertexAttrib3(1,o.c.X,o.c.Y,o.c.Z);g.DrawElements(PrimitiveType.Triangles,(uint)l.Length,DrawElementsType.UnsignedInt,null);}foreach(var e in en){var t=Matrix4x4.CreateScale(1+e.ht*2)*Matrix4x4.CreateTranslation(e.p);g.UniformMatrix4(ml,1,false,(float*)&t);g.VertexAttrib3(1,1f-e.h/100f,e.h/200f,0);g.DrawElements(PrimitiveType.Triangles,(uint)l.Length,DrawElementsType.UnsignedInt,null);e.ht=Math.Max(0,e.ht-(float)dt*5);}foreach(var pr in pj){var t=Matrix4x4.CreateScale(.2f)*Matrix4x4.CreateTranslation(pr.p);g.UniformMatrix4(ml,1,false,(float*)&t);g.VertexAttrib3(1,pr.c.X,pr.c.Y,pr.c.Z);g.DrawElements(PrimitiveType.Triangles,(uint)l.Length,DrawElementsType.UnsignedInt,null);}ic.Render();ImGui.SetNextWindowPos(new(10,10));ImGui.SetNextWindowSize(new(200,180));ImGui.Begin("HUD",ImGuiWindowFlags.NoTitleBar|ImGuiWindowFlags.NoResize|ImGuiWindowFlags.NoMove);ImGui.TextColored(new Vector4(1,h/mh,h/mh,1),$"Health: {h:0}/{mh}");ImGui.TextColored(new Vector4(1,1,0,1),$"Ammo: {am}/{mm}");ImGui.TextColored(new Vector4(0,1,1,1),$"Wave: {wv}");ImGui.TextColored(new Vector4(1,0.5f,0,1),$"Kills: {ki}");ImGui.TextColored(new Vector4(1,0,0,1),$"Enemies: {en.Count}");if(de)ImGui.TextColored(new Vector4(1,0,0,1),"YOU DIED! Press R to Respawn");ImGui.Separator();ImGui.TextColored(new Vector4(0.7f,0.7f,0.7f,1),"[LMB] Shoot [RMB] Shotgun");ImGui.TextColored(new Vector4(0.7f,0.7f,0.7f,1),"[Shift] Sprint [Space] Jump");ImGui.End();ic.Draw();}
void SW(){wv++;for(int i=0;i<Math.Min(wv*2+3,20);i++)en.Add(new E{p=new(r.Next(-25,25),1,r.Next(-25,25)),h=80+wv*20,s=2f+wv*.3f,mh=80+wv*20});am=mm;fl=true;}
public void Dispose(){g?.DeleteVertexArray(v);g?.DeleteBuffer(b);g?.DeleteBuffer(e);g?.DeleteProgram(s);ic?.Dispose();}
class E{public Vector3 p;public float h,s,mh,ht;public void U(float dt,Vector3 t){var d=t-p;if(d.LengthSquared()>4){d.Y=0;p+=Vector3.Normalize(d)*s*dt;}}}class P{public Vector3 p,v,c;public float l;public void U(float dt){p+=v*dt;v.Y-=10*dt;l-=dt;}}class O{public Vector3 p,s,c;}class ImGuiController:IDisposable{Silk.NET.OpenGL.Extensions.ImGui.ImGuiController c;public ImGuiController(GL g,IWindow w,IInputContext i)=>c=new(g,w,i);public void Update(float dt)=>c.Update(dt);public void Render()=>c.Render();public void Draw()=>c.Render();public void Dispose()=>c?.Dispose();}}