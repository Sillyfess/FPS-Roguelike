using System;using System.Collections.Generic;using System.Numerics;using System.Runtime.InteropServices;using Silk.NET.Input;using Silk.NET.OpenGL;using Silk.NET.OpenGL.Extensions.ImGui;using Silk.NET.Windowing;using Silk.NET.Maths;using ImGuiNET;unsafe class G:IDisposable{IWindow w;GL g;IInputContext i;IMouse m;IKeyboard k;uint v,b,e,s;float[]d;uint[]l;Vector3 p=new(0,1.7f,0),vel;Matrix4x4 vw,pr;List<E>en=new();List<P>pj=new();List<O>ob=new();float h=100,mh=100,ft=1f/60f,mx,my,js=5,ms=5,sens=.002f,fov=90;int wv=1,ki,am=30,mm=30,wt;bool gr,de;double ac;Random r=new();ImGuiController ic;const string vs=@"#version 330 core
layout(location=0)in vec3 aPos;layout(location=1)in vec3 aCol;out vec3 Col;uniform mat4 model;uniform mat4 view;uniform mat4 proj;void main(){gl_Position=proj*view*model*vec4(aPos,1.0);Col=aCol;}",fs=@"#version 330 core
in vec3 Col;out vec4 FragColor;void main(){FragColor=vec4(Col,1.0);}";static void Main(){var o=WindowOptions.Default with{Size=new(1280,720),Title="FPS"};var w=Window.Create(o);w.Load+=()=>{var g=new G();g.I(w,GL.GetApi(w));w.Update+=g.U;w.Render+=g.R;w.Closing+=g.Dispose;};w.Run();}void I(IWindow win,GL gl){w=win;g=gl;g.Enable(EnableCap.DepthTest);g.ClearColor(.1f,.1f,.15f,1);i=w.CreateInput();m=i.Mice[0];k=i.Keyboards[0];m.Cursor.CursorMode=CursorMode.Raw;m.MouseMove+=(m,pos)=>{mx+=pos.X*sens;my=Math.Clamp(my-pos.Y*sens,-1.5f,1.5f);};k.KeyDown+=(k,key,_)=>{if(key==Key.Space&&gr)vel.Y=js;if(key==Key.R&&de){de=false;h=mh;p=new(0,1.7f,0);en.Clear();SW();}if(key==Key.Number1)wt=0;if(key==Key.Number2)wt=1;if(key==Key.Number3)wt=2;};ic=new(g,w,i);d=new[]{-.5f,-.5f,-.5f,1,0,0,.5f,-.5f,-.5f,1,0,0,.5f,.5f,-.5f,1,0,0,-.5f,.5f,-.5f,1,0,0,-.5f,-.5f,.5f,0,1,0,.5f,-.5f,.5f,0,1,0,.5f,.5f,.5f,0,1,0,-.5f,.5f,.5f,0,1,0};l=new uint[]{0,1,2,2,3,0,4,5,6,6,7,4,0,4,7,7,3,0,1,5,6,6,2,1,3,2,6,6,7,3,0,1,5,5,4,0};v=g.GenVertexArray();b=g.GenBuffer();e=g.GenBuffer();g.BindVertexArray(v);g.BindBuffer(BufferTargetARB.ArrayBuffer,b);fixed(void*ptr=d)g.BufferData(BufferTargetARB.ArrayBuffer,(nuint)(d.Length*sizeof(float)),ptr,BufferUsageARB.StaticDraw);g.BindBuffer(BufferTargetARB.ElementArrayBuffer,e);fixed(void*ptr=l)g.BufferData(BufferTargetARB.ElementArrayBuffer,(nuint)(l.Length*sizeof(uint)),ptr,BufferUsageARB.StaticDraw);g.VertexAttribPointer(0,3,VertexAttribPointerType.Float,false,6*sizeof(float),(void*)0);g.EnableVertexAttribArray(0);g.VertexAttribPointer(1,3,VertexAttribPointerType.Float,false,6*sizeof(float),(void*)(3*sizeof(float)));g.EnableVertexAttribArray(1);var vsh=g.CreateShader(ShaderType.VertexShader);g.ShaderSource(vsh,vs);g.CompileShader(vsh);var fsh=g.CreateShader(ShaderType.FragmentShader);g.ShaderSource(fsh,fs);g.CompileShader(fsh);s=g.CreateProgram();g.AttachShader(s,vsh);g.AttachShader(s,fsh);g.LinkProgram(s);g.DeleteShader(vsh);g.DeleteShader(fsh);for(int x=-20;x<=20;x+=5)for(int z=-20;z<=20;z+=5)if(r.NextDouble()>.7)ob.Add(new O{p=new(x,1,z),s=new(1,2,1)});SW();}void U(double dt){if(de)return;ac+=dt;while(ac>=ft){vel.Y-=9.8f*ft;var mv=Vector3.Zero;if(k.IsKeyPressed(Key.W))mv.Z=-1;if(k.IsKeyPressed(Key.S))mv.Z=1;if(k.IsKeyPressed(Key.A))mv.X=-1;if(k.IsKeyPressed(Key.D))mv.X=1;if(mv.LengthSquared()>0){mv=Vector3.Normalize(mv);var fw=new Vector3((float)Math.Sin(mx),0,(float)-Math.Cos(mx));var rt=Vector3.Normalize(Vector3.Cross(fw,Vector3.UnitY));mv=rt*mv.X+Vector3.Cross(Vector3.UnitY,rt)*mv.Z;p+=mv*ms*ft;}p.Y+=vel.Y*ft;if(p.Y<=1.7f){p.Y=1.7f;vel.Y=0;gr=true;}else gr=false;if(m.IsButtonPressed(MouseButton.Left)&&!de&&am>0){am--;var dir=new Vector3((float)Math.Sin(mx),(float)Math.Sin(my),(float)-Math.Cos(mx));pj.Add(new P{p=p+new Vector3(0,.5f,0),v=dir*20,l=5});}for(int i=en.Count-1;i>=0;i--){en[i].U(ft,p);if(Vector3.Distance(en[i].p,p)<1.5f){h-=10;if(h<=0){de=true;h=0;}}}for(int i=pj.Count-1;i>=0;i--){pj[i].U(ft);if(pj[i].l<=0)pj.RemoveAt(i);}for(int i=pj.Count-1;i>=0;i--)for(int j=en.Count-1;j>=0;j--)if(Vector3.Distance(pj[i].p,en[j].p)<1){en[j].h-=wt==0?34:wt==1?10:50;if(en[j].h<=0){en.RemoveAt(j);ki++;}pj.RemoveAt(i);break;}if(en.Count==0)SW();ac-=ft;}ic.Update((float)dt);var fw2=new Vector3((float)Math.Sin(mx),(float)Math.Sin(my),(float)-Math.Cos(mx));vw=Matrix4x4.CreateLookAt(p+new Vector3(0,.5f,0),p+new Vector3(0,.5f,0)+fw2,Vector3.UnitY);pr=Matrix4x4.CreatePerspectiveFieldOfView(fov*MathF.PI/180,w.Size.X/(float)w.Size.Y,0.1f,100f);}void R(double dt){g.Clear(ClearBufferMask.ColorBufferBit|ClearBufferMask.DepthBufferBit);g.UseProgram(s);var ml=g.GetUniformLocation(s,"model");var vl=g.GetUniformLocation(s,"view");var pl=g.GetUniformLocation(s,"proj");var vwt=vw;var prt=pr;g.UniformMatrix4(vl,1,false,(float*)&vwt);g.UniformMatrix4(pl,1,false,(float*)&prt);g.BindVertexArray(v);foreach(var o in ob){var t=Matrix4x4.CreateScale(o.s)*Matrix4x4.CreateTranslation(o.p);g.UniformMatrix4(ml,1,false,(float*)&t);g.DrawElements(PrimitiveType.Triangles,(uint)l.Length,DrawElementsType.UnsignedInt,null);}foreach(var e in en){var t=Matrix4x4.CreateTranslation(e.p);g.UniformMatrix4(ml,1,false,(float*)&t);g.DrawElements(PrimitiveType.Triangles,(uint)l.Length,DrawElementsType.UnsignedInt,null);}foreach(var pr in pj){var t=Matrix4x4.CreateScale(.1f)*Matrix4x4.CreateTranslation(pr.p);g.UniformMatrix4(ml,1,false,(float*)&t);g.DrawElements(PrimitiveType.Triangles,(uint)l.Length,DrawElementsType.UnsignedInt,null);}ic.Render();ImGui.Begin("HUD",ImGuiWindowFlags.NoTitleBar|ImGuiWindowFlags.NoResize|ImGuiWindowFlags.NoMove|ImGuiWindowFlags.NoBackground);ImGui.SetWindowPos(new(10,10));ImGui.Text($"Health:{h:0}/{mh}");ImGui.Text($"Ammo:{am}/{mm}");ImGui.Text($"Wave:{wv}");ImGui.Text($"Kills:{ki}");ImGui.Text($"Enemies:{en.Count}");if(de)ImGui.Text("DEAD - Press R to Respawn");ImGui.End();ic.Draw();}void SW(){wv++;for(int i=0;i<wv*3+2;i++)en.Add(new E{p=new(r.Next(-30,30),0,r.Next(-30,30)),h=100+wv*10,s=.001f+wv*.0005f});am=mm;}public void Dispose(){g?.DeleteVertexArray(v);g?.DeleteBuffer(b);g?.DeleteBuffer(e);g?.DeleteProgram(s);ic?.Dispose();}class E{public Vector3 p;public float h,s;public void U(float dt,Vector3 t){var d=t-p;if(d.LengthSquared()>0.01f){d.Y=0;p+=Vector3.Normalize(d)*s;}}}
class P{public Vector3 p,v;public float l;public void U(float dt){p+=v*dt;l-=dt;}}
class O{public Vector3 p,s;}
class ImGuiController:IDisposable{Silk.NET.OpenGL.Extensions.ImGui.ImGuiController c;public ImGuiController(GL g,IWindow w,IInputContext i)=>c=new(g,w,i);public void Update(float dt)=>c.Update(dt);public void Render()=>c.Render();public void Draw()=>c.Render();public void Dispose()=>c?.Dispose();}}